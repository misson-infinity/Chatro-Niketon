<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡ßá‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tiro+Bangla:ital@0;1&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Tiro Bangla', sans-serif;
            background-color: #f0f2f5;
        }
        .loader-container {
            position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8);
            z-index: 200; display: flex; align-items: center; justify-content: center;
        }
        .loader {
            border: 8px solid #f3f3f3; border-radius: 50%;
            border-top: 8px solid #3498db; width: 60px; height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none; position: fixed; z-index: 100;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 500px;
            border-radius: 10px; animation: modal-appear 0.3s;
        }
        @keyframes modal-appear { from { opacity: 0; transform: scale(0.95) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .toast {
            position: fixed; top: 20px; right: 20px;
            padding: 12px 20px; border-radius: 8px;
            color: white; z-index: 9999;
            opacity: 0; transform: translateY(-20px);
            transition: all 0.5s ease;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        .slide-in { animation: slide-in 0.5s forwards; }
        .slide-out { animation: slide-out 0.5s forwards; }
        @keyframes slide-in { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes slide-out { from { transform: translateX(0); } to { transform: translateX(-100%); } }
    </style>
</head>
<body>

    <div id="loader-container" class="loader-container">
        <div class="loader"></div>
    </div>
    
    <div id="toast" class="toast"></div>

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4 bg-gray-100">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <div id="login-form">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <form id="login">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 mb-2">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="login-password" class="block text-gray-700 mb-2">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                     <p class="text-right mb-4"><a href="#" id="forgot-password" class="text-sm text-blue-600 hover:underline">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</a></p>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300">‡¶≤‡¶ó‡¶á‡¶®</button>
                </form>
                <p class="text-center mt-4">
                    ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <a href="#" id="show-signup" class="text-blue-600 hover:underline">‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®</a>
                </p>
            </div>
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <form id="signup">
                    <div class="mb-4"><label class="block text-gray-700 mb-2">‡¶®‡¶æ‡¶Æ</label><input type="text" id="signup-name" class="w-full px-4 py-2 border rounded-lg" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label><input type="text" id="signup-address" class="w-full px-4 py-2 border rounded-lg" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (e.g., 8801...)</label><input type="text" id="signup-number" class="w-full px-4 py-2 border rounded-lg" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">‡¶ï‡¶≤‡ßá‡¶ú/‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label><input type="email" id="signup-email" class="w-full px-4 py-2 border rounded-lg" required></div>
                    <div class="mb-6"><label class="block text-gray-700 mb-2">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label><input type="password" id="signup-password" class="w-full px-4 py-2 border rounded-lg" required></div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™</button>
                </form>
                <p class="text-center mt-4">
                    ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <a href="#" id="show-login" class="text-green-600 hover:underline">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a>
                </p>
            </div>
        </div>
    </div>

    <div id="mess-choice-container" class="hidden min-h-screen flex items-center justify-center p-4 bg-gray-100">
        <div class="max-w-lg w-full bg-white p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <span id="choice-user-name"></span>!</h2>
            <p class="text-gray-600 mb-8">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border p-6 rounded-lg hover:shadow-md transition-shadow">
                    <h3 class="text-xl font-semibold mb-4">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®</h3>
                    <form id="join-mess-form">
                        <input type="text" id="mess-code" maxlength="6" class="w-full text-center text-2xl tracking-[0.5em] font-bold p-3 border rounded-lg mb-4" placeholder="_ _ _ _ _ _" required>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
                    </form>
                </div>
                <div class="border p-6 rounded-lg hover:shadow-md transition-shadow">
                    <h3 class="text-xl font-semibold mb-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <form id="create-mess-form">
                        <input type="text" id="mess-name-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-lg mb-4" required>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">‡¶Æ‡ßá‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </form>
                </div>
            </div>
            <p id="choice-status" class="text-center mt-6 text-orange-600 font-semibold"></p>
            <button id="logout-btn-choice" class="mt-8 text-red-500 hover:underline">‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü</button>
        </div>
    </div>

    <div id="main-app-container" class="hidden">
        <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-800 text-white z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="p-4 flex justify-between items-center border-b border-gray-700">
                <h2 id="sidebar-mess-name" class="text-xl font-bold"></h2>
                <button id="close-sidebar" class="text-2xl font-bold text-gray-400 hover:text-white">&times;</button>
            </div>
            <nav id="sidebar-nav" class="mt-4 p-2"></nav>
            <div class="absolute bottom-4 w-full px-4">
                 <button id="logout-btn-main" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü</button>
            </div>
        </div>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-40 hidden"></div>

        <div class="transition-all duration-300 ease-in-out">
            <header class="bg-white shadow-md sticky top-0 z-30">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center">
                        <button id="open-sidebar" class="text-gray-700 text-2xl mr-4">&#9776;</button>
                        <div>
                            <h1 id="header-mess-name" class="text-xl font-bold text-gray-800"></h1>
                            <p id="header-date-time" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-700" id="user-name-display"></p>
                        <p class="text-sm text-gray-500" id="user-role-display"></p>
                    </div>
                </div>
            </header>

            <main id="page-content" class="container mx-auto p-4 md:p-6"></main>
        </div>
    </div>

    <div id="generic-modal-container"></div>

    <script type="module">
        // ############ FIREBASE INITIALIZATION ############
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, onSnapshot, updateDoc, deleteDoc, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

        // WARNING: It's not secure to expose API keys in client-side code.
        // Use environment variables or a backend proxy in a real production app.
        const firebaseConfig = {
            apiKey: "AIzaSyCvars41WY81WmVy1Tueo_rrSO90aIv_Gw",
            authDomain: "try-382fa.firebaseapp.com",
            projectId: "try-382fa",
            storageBucket: "try-382fa.appspot.com",
            messagingSenderId: "952752280975",
            appId: "1:952752280975:web:9025fc4a4efe34f78be7fa",
            measurementId: "G-73PLMXERXX"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const messaging = getMessaging(app);

        // ############ GLOBAL STATE & VARIABLES ############
        let currentUser = null, userData = null, messData = null, currentMessId = null;
        let membersData = [];
        let unsubscribeListeners = [];
        let currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format

        // UI Elements
        const loader = document.getElementById('loader-container');
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const messChoiceContainer = document.getElementById('mess-choice-container');
        const pageContent = document.getElementById('page-content');

        // ############ UTILITY FUNCTIONS ############
        const showView = (view) => {
            [authContainer, mainAppContainer, messChoiceContainer].forEach(v => v.classList.add('hidden'));
            if (view) view.classList.remove('hidden');
            loader.classList.add('hidden');
        };

        const showToast = (message, type = 'info') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        };
        
        const showModal = (title, content, footer) => {
            const modalContainer = document.getElementById('generic-modal-container');
            modalContainer.innerHTML = `
                <div id="dynamic-modal" class="modal" style="display:block;">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b">
                            <h3 class="text-xl font-bold text-gray-700">${title}</h3>
                            <button id="modal-close-btn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div id="modal-body">${content}</div>
                        <div id="modal-footer" class="mt-6 text-right space-x-2">${footer}</div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        };
        
        const closeModal = () => {
            const modal = document.getElementById('dynamic-modal');
            if(modal) modal.style.display = 'none';
            document.getElementById('generic-modal-container').innerHTML = '';
        };

        const showConfirmation = (title, message, onConfirm, confirmText = '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§', confirmClass = 'bg-red-600 hover:bg-red-700') => {
            const content = `<p>${message}</p>`;
            const footer = `
                <button id="confirm-cancel" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button id="confirm-ok" class="px-4 py-2 text-white rounded-lg ${confirmClass}">${confirmText}</button>
            `;
            showModal(title, content, footer);
            document.getElementById('confirm-cancel').addEventListener('click', closeModal);
            document.getElementById('confirm-ok').addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
        };

        const formatDateTime = (date) => new Intl.DateTimeFormat('bn-BD', { dateStyle: 'full', timeStyle: 'medium' }).format(date);
        const formatDate = (date) => new Intl.DateTimeFormat('bn-BD', { dateStyle: 'long' }).format(date);
        
        const toYYYYMMDD = (date) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const toBengaliNum = (num) => num.toLocaleString('bn-BD');

        // ############ AUTHENTICATION LOGIC ############
        document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });

        document.getElementById('signup').addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.classList.remove('hidden');
            const name = document.getElementById('signup-name').value;
            const address = document.getElementById('signup-address').value;
            const phone = document.getElementById('signup-number').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), { name, address, phone, email, role: 'member', messId: null, rent: 0, createdAt: Timestamp.now() });
                // onAuthStateChanged will handle the rest
            } catch (error) {
                showToast("‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.code, 'error');
                loader.classList.add('hidden');
            }
        });

        document.getElementById('login').addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.classList.remove('hidden');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showToast("‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.code, 'error');
                loader.classList.add('hidden');
            }
        });
        
        document.getElementById('forgot-password').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            if (!email) {
                showToast('‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶®‡•§', 'error');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showToast('‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            } catch (error) {
                showToast('‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ' + error.code, 'error');
            }
        });

        const handleLogout = async () => {
            loader.classList.remove('hidden');
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            await signOut(auth);
            currentUser = userData = messData = currentMessId = null;
            membersData = [];
            pageContent.innerHTML = '';
        };
        [...document.querySelectorAll('[id^="logout-btn"]')].forEach(btn => btn.addEventListener('click', handleLogout));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocSnap = await getDoc(doc(db, "users", user.uid));

                if (userDocSnap.exists()) {
                    userData = { id: user.uid, ...userDocSnap.data() };
                    
                    if (userData.messId && !userData.messId.startsWith('pending_')) {
                        currentMessId = userData.messId;
                        await initializeMainApp();
                    } else {
                        showView(messChoiceContainer);
                        document.getElementById('choice-user-name').textContent = userData.name;
                        if (userData.messId && userData.messId.startsWith('pending_')) {
                            document.getElementById('choice-status').textContent = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡¶§‡•§';
                            document.querySelector('#mess-choice-container .grid').classList.add('hidden');
                        }
                    }
                } else {
                    console.error("User document not found in Firestore!");
                    showView(authContainer);
                }
            } else {
                showView(authContainer);
            }
        });

        // ############ MESS MANAGEMENT LOGIC ############
        document.getElementById('join-mess-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.classList.remove('hidden');
            const code = document.getElementById('mess-code').value;
            
            const q = query(collection(db, "messes"), where("joinCode", "==", code));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showToast('‡¶≠‡ßÅ‡¶≤ ‡¶ï‡ßã‡¶°‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
                loader.classList.add('hidden');
            } else {
                const messId = querySnapshot.docs[0].id;
                await updateDoc(doc(db, "users", currentUser.uid), { messId: `pending_${messId}` });
                showToast('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß‡¶ü‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                // onAuthStateChanged will handle the view change
            }
        });
        
        document.getElementById('create-mess-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.classList.remove('hidden');
            const messName = document.getElementById('mess-name-input').value;
            const joinCode = Math.floor(100000 + Math.random() * 900000).toString();

            try {
                const messDocRef = await addDoc(collection(db, 'messes'), { messName, joinCode, managerId: currentUser.uid, managerName: userData.name, createdAt: Timestamp.now(), shopCredit: 0 });
                await updateDoc(doc(db, "users", currentUser.uid), { messId: messDocRef.id, role: 'admin' });
                
                showConfirmation('‡¶Æ‡ßá‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶´‡¶≤!', `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶¶‡ßá‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶á ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®: <br><strong class="text-2xl tracking-widest text-blue-600">${joinCode}</strong>`, () => {}, '‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá', 'bg-blue-600 hover:bg-blue-700');
                // onAuthStateChanged will handle app initialization
            } catch (error) {
                showToast('‡¶Æ‡ßá‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                loader.classList.add('hidden');
            }
        });
        
        // ############ NOTIFICATION LOGIC ############
        const requestNotificationPermissionAndSaveToken = async () => {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    const vapidKey = "BOzsQ8MpTM4VhGYaQPSx0z9x7dalcCAsBjLPb_A9MT68K8DWiNidnvoJwtFowOyi9IaPB3tPgfXjW4vIG9yX2Q4";
                    const token = await getToken(messaging, { vapidKey });
                    
                    if (token) {
                        console.log('FCM token:', token);
                        await updateDoc(doc(db, "users", currentUser.uid), { fcmToken: token });
                    }
                } else {
                    console.log('Notification permission denied.');
                }
            } catch (error) {
                console.error('Error getting permission or token:', error);
            }
        };

        const setupNotificationListeners = () => {
            onMessage(messaging, (payload) => {
                console.log('Foreground message received. ', payload);
                const notificationTitle = payload.notification.title;
                const notificationOptions = {
                    body: payload.notification.body,
                    icon: '/favicon.png'
                };
                new Notification(notificationTitle, notificationOptions);
            });
        };
        
        // ############ MAIN APP INITIALIZATION & NAVIGATION ############
        const initializeMainApp = async () => {
            if (!currentMessId) return;
            const messDocSnap = await getDoc(doc(db, "messes", currentMessId));
            if (!messDocSnap.exists()) {
                showToast("‡¶Æ‡ßá‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø! ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§", 'error');
                await updateDoc(doc(db, "users", currentUser.uid), { messId: null });
                handleLogout();
                return;
            }
            messData = { id: messDocSnap.id, ...messDocSnap.data() };

            document.getElementById('header-mess-name').textContent = messData.messName;
            document.getElementById('sidebar-mess-name').textContent = messData.messName;
            document.getElementById('user-name-display').textContent = userData.name;
            document.getElementById('user-role-display').textContent = userData.role === 'admin' ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø';
            setInterval(() => { document.getElementById('header-date-time').textContent = formatDateTime(new Date()); }, 1000);

            setupSidebar();
            setupListeners();
            setupNotificationListeners(); // Add this line
            navigateTo('dashboard');
            showView(mainAppContainer);
        };
        
        const setupListeners = () => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const membersQuery = query(collection(db, "users"), where("messId", "==", currentMessId));
            const unsubMembers = onSnapshot(membersQuery, (snapshot) => {
                membersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentPage = pageContent.dataset.page;
                if (pageContent.innerHTML !== '' && currentPage) {
                    navigateTo(currentPage, true);
                }
            }, (error) => {
                console.error("Member listener error:", error);
                showToast("‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶®‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§", "error");
            });
            unsubscribeListeners.push(unsubMembers);
            
            const unsubMess = onSnapshot(doc(db, "messes", currentMessId), (doc) => {
                if(doc.exists()) {
                    messData = { id: doc.id, ...doc.data() };
                    const currentPage = pageContent.dataset.page;
                    if (pageContent.innerHTML !== '' && currentPage) {
                        navigateTo(currentPage, true);
                    }
                }
            });
            unsubscribeListeners.push(unsubMess);
        };
        
        const setupSidebar = () => {
            const nav = document.getElementById('sidebar-nav');
            let navItems = [
                { id: 'dashboard', text: '‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°', icon: 'üè†' },
                { id: 'myProfile', text: '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤', icon: 'üë§' },
                { id: 'bazarKhoroch', text: '‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö', icon: 'üõí' },
                { id: 'mealCount', text: '‡¶Æ‡¶ø‡¶≤ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ', icon: 'üçΩÔ∏è' },
                { id: 'monthlyReport', text: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö', icon: 'üìä' },
                { id: 'membersInfo', text: '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø', icon: 'üë•' },
                { id: 'developerInfo', text: '‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø', icon: 'üë®‚Äçüíª' },
            ];

            if (userData.role === 'admin') {
                navItems.splice(1, 0, { id: 'approvals', text: '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®', icon: '‚úÖ' });
                navItems.splice(2, 0, { id: 'mealRequests', text: '‡¶Æ‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú', icon: '‚úâÔ∏è' });
            }
            
            nav.innerHTML = navItems.map(item => `<a href="#" data-page="${item.id}" class="nav-link flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md m-1"><span class="mr-3">${item.icon}</span>${item.text}</a>`).join('');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(e.currentTarget.dataset.page); closeSidebar(); });
            });
        };

        const navigateTo = (pageId, isRefresh = false) => {
            if (!isRefresh) {
                pageContent.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>';
            }
            pageContent.dataset.page = pageId;

            const pageRenderers = {
                'dashboard': renderDashboard, 'myProfile': renderMyProfile,
                'bazarKhoroch': renderBazarKhoroch, 'mealCount': renderMealCount,
                'monthlyReport': renderMonthlyReport, 'membersInfo': renderMembersInfo,
                'developerInfo': renderDeveloperInfo, 'approvals': renderApprovals,
                'mealRequests': renderMealRequests
            };

            if (pageRenderers[pageId]) {
                if ((['approvals', 'mealRequests'].includes(pageId)) && userData.role !== 'admin') {
                    pageContent.innerHTML = '<div class="text-center p-8 bg-white rounded-lg shadow"><h2 class="text-2xl font-bold text-red-500">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂‡¶æ‡¶ß‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á</h2><p class="mt-2">‡¶è‡¶á ‡¶™‡ßá‡¶ú‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§</p></div>';
                } else {
                    pageRenderers[pageId]();
                }
            }
        };
        
        const openSidebar = () => { 
            document.getElementById('sidebar').classList.remove('-translate-x-full'); 
            document.getElementById('sidebar-overlay').classList.remove('hidden'); 
        };
        const closeSidebar = () => { 
            document.getElementById('sidebar').classList.add('-translate-x-full'); 
            document.getElementById('sidebar-overlay').classList.add('hidden'); 
        };
        document.getElementById('open-sidebar').addEventListener('click', openSidebar);
        document.getElementById('close-sidebar').addEventListener('click', closeSidebar);
        document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/firebase-messaging-sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered with scope:', registration.scope);
                        // ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶ö‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
                        requestNotificationPermissionAndSaveToken();
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // ############ PAGE RENDERING FUNCTIONS ############

        // ==================== DASHBOARD ====================
        async function renderDashboard() {
            // Unsubscribe from previous listeners to avoid memory leaks
            if (window.dashboardMealListener) window.dashboardMealListener();
            if (window.dashboardNoticeListener) window.dashboardNoticeListener();
            
            const todayStr = toYYYYMMDD(new Date());

            const startOfMonth = currentMonth + '-01';
            const endOfMonth = new Date(new Date(currentMonth).getFullYear(), new Date(currentMonth).getMonth() + 1, 0).toISOString().slice(0, 10);
            
            const mealDocsQuery = query(collection(db, `messes/${currentMessId}/meals`), where("__name__", ">=", startOfMonth), where("__name__", "<=", endOfMonth));

            window.dashboardMealListener = onSnapshot(mealDocsQuery, (querySnapshot) => {
                const allMeals = {};
                querySnapshot.forEach(doc => { allMeals[doc.id] = doc.data().meals || {}; });
                
                const mealsForToday = allMeals[todayStr] || {};
                const mealDocSnap = querySnapshot.docs.find(d => d.id === todayStr);
                const mealDataToday = mealDocSnap?.data() || { dailyBazarPersonName: '‡¶è‡¶ñ‡¶®‡ßã ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø', meals: {} };

                const noticesQuery = query(collection(db, `messes/${currentMessId}/notices`));
                
                window.dashboardNoticeListener = onSnapshot(noticesQuery, (noticeSnapshot) => {
                    const notices = noticeSnapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a, b) => b.timestamp - a.timestamp);
                    
                    let html = `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                                        <span>${new Date(currentMonth).toLocaleString('bn-BD', { month: 'long', year: 'numeric' })}</span>
                                        <input type="month" id="month-selector" value="${currentMonth}" class="p-1 border rounded">
                                    </h2>
                                    <h3 class="text-lg font-bold mb-4">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h3>
                                    <p><strong>‡¶Æ‡ßá‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞:</strong> ${messData.managerName}</p>
                                    <div class="flex items-center justify-between mt-2">
                                        <p><strong>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞:</strong> <span id="bazar-person-name">${mealDataToday.dailyBazarPersonName}</span></p>
                                        ${userData.role === 'admin' ? `
                                            <select id="bazar-person-select" class="p-1 border rounded">
                                                <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                                                ${membersData.map(m => `<option value="${m.id}" ${mealDataToday.dailyBazarPersonId === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                                            </select>
                                        ` : ''}
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-lg shadow">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-xl font-bold">‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2>
                                        ${userData.role === 'admin' ? `<button id="add-notice-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶∂</button>` : ''}
                                    </div>
                                    <div id="notice-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                        ${notices.length > 0 ? notices.map(n => `
                                            <div class="border p-4 rounded-lg">
                                                <h3 class="font-bold">${n.title}</h3>
                                                <p class="text-gray-600 whitespace-pre-wrap">${n.content}</p>
                                                <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                                                    <span>${n.authorName} - ${formatDate(n.timestamp.toDate())}</span>
                                                    <div>
                                                        <button class="view-comments-btn text-blue-500 hover:underline mr-2" data-notice-id="${n.id}" data-notice-title="${n.title}">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                                                        ${userData.role === 'admin' ? `
                                                            <button class="edit-notice-btn text-green-500 hover:underline mr-2" data-notice-id="${n.id}" data-notice-title="${n.title}" data-notice-content="${n.content}">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</button>
                                                            <button class="delete-notice-btn text-red-500 hover:underline" data-notice-id="${n.id}">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('') : '<p>‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶®‡ßá‡¶á‡•§</p>'}
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h2 class="text-xl font-bold mb-4">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶≤ (${formatDate(new Date())})</h2>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-gray-100"><tr><th class="p-2">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</th><th class="p-2 text-center">‡¶∏‡¶ï‡¶æ‡¶≤</th><th class="p-2 text-center">‡¶¶‡ßÅ‡¶™‡ßÅ‡¶∞</th><th class="p-2 text-center">‡¶∞‡¶æ‡¶§</th></tr></thead>
                                            <tbody>
                                                ${membersData.map(m => `
                                                    <tr class="border-b">
                                                        <td class="p-2 font-medium">${m.name}</td>
                                                        ${['breakfast', 'lunch', 'dinner'].map(mealType => `
                                                            <td class="p-2 text-center">
                                                                <input type="number" class="meal-input w-16 p-1 border rounded text-center" data-userid="${m.id}" data-mealtype="${mealType}" value="${(mealsForToday[m.id] && mealsForToday[m.id][mealType]) ? mealsForToday[m.id][mealType] : 0}" ${mealType === 'breakfast' ? 'step="0.5"' : 'step="1"'} min="0" ${userData.role !== 'admin' ? 'disabled' : ''}>
                                                            </td>
                                                        `).join('')}
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    ${userData.role === 'admin' ? `
                                        <div class="text-center mt-4">
                                            <button id="update-today-meal-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                                        </div>
                                    ` : ''}
                                </div>

                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h2 class="text-xl font-bold mb-4">‡¶Æ‡¶ø‡¶≤ ‡¶ö‡¶æ‡¶≤‡ßÅ/‡¶¨‡¶®‡ßç‡¶ß ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</h2>
                                    <form id="meal-message-form">
                                        <textarea id="meal-message-text" class="w-full p-2 border rounded mb-2" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶ø‡¶≤ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶¨‡¶æ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡¶ï‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡¶ø‡¶®..." required></textarea>
                                        <button type="submit" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    `;
                    pageContent.innerHTML = html;
                    attachDashboardListeners();
                });
            });
        }
        
        function attachDashboardListeners() {
            document.getElementById('month-selector').addEventListener('change', (e) => {
                currentMonth = e.target.value;
                navigateTo('dashboard', true);
            });

            if (userData.role === 'admin') {
                document.getElementById('add-notice-btn')?.addEventListener('click', () => {
                    const content = `
                        <form id="add-notice-form">
                            <input type="text" id="notice-title" placeholder="‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ" class="w-full p-2 border rounded mb-2" required>
                            <textarea id="notice-content" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§" class="w-full p-2 border rounded mb-4" rows="4" required></textarea>
                        </form>`;
                    const footer = `<button id="add-notice-submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                    showModal('‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®', content, footer);
                    document.getElementById('add-notice-submit').addEventListener('click', async () => {
                        const title = document.getElementById('notice-title').value;
                        const content = document.getElementById('notice-content').value;
                        if (!title || !content) { showToast('‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§', 'error'); return; }
                        await addDoc(collection(db, `messes/${currentMessId}/notices`), { title, content, authorId: currentUser.uid, authorName: userData.name, timestamp: Timestamp.now() });
                        closeModal();
                        showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                    });
                });
                
                attachDashboardNoticeEditListener();

                document.getElementById('bazar-person-select')?.addEventListener('change', async (e) => {
                    const userId = e.target.value;
                    const userName = e.target.options[e.target.selectedIndex].text;
                    const todayStr = toYYYYMMDD(new Date());

                    try {
                        const mealDocRef = doc(db, `messes/${currentMessId}/meals`, todayStr);
                        const mealDocSnap = await getDoc(mealDocRef);
                        if (mealDocSnap.exists()) {
                            await updateDoc(mealDocRef, { dailyBazarPersonId: userId, dailyBazarPersonName: userName });
                        } else {
                            await setDoc(mealDocRef, { dailyBazarPersonId: userId, dailyBazarPersonName: userName, meals: {} });
                        }
                        showToast('‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                    } catch (error) {
                        showToast('‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                        console.error("Error updating bazar person:", error);
                    }
                });

                document.getElementById('update-today-meal-btn')?.addEventListener('click', async () => {
                    const todayStr = toYYYYMMDD(new Date());
                    const mealInputs = document.querySelectorAll('.meal-input');
                    const newMeals = {};

                    mealInputs.forEach(input => {
                        const userId = input.dataset.userid;
                        const mealType = input.dataset.mealtype;
                        const mealValue = parseFloat(input.value);

                        if (!newMeals[userId]) newMeals[userId] = {};
                        newMeals[userId][mealType] = mealValue;
                    });
                    
                    try {
                        const mealDocRef = doc(db, `messes/${currentMessId}/meals`, todayStr);
                        const mealDocSnap = await getDoc(mealDocRef);
                        
                        if(mealDocSnap.exists()) {
                           await updateDoc(mealDocRef, { meals: newMeals });
                        } else {
                           const dailyBazarPersonId = document.getElementById('bazar-person-select')?.value || '';
                           const dailyBazarPersonName = document.getElementById('bazar-person-select')?.options[document.getElementById('bazar-person-select')?.selectedIndex]?.text || '‡¶è‡¶ñ‡¶®‡ßã ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø';
                           await setDoc(mealDocRef, { dailyBazarPersonId, dailyBazarPersonName, meals: newMeals });
                        }
                        showToast('‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶≤ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                    } catch (error) {
                        showToast('‡¶Æ‡¶ø‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                        console.error("Error updating meals:", error);
                    }
                });
            }

            document.querySelectorAll('.delete-notice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const noticeId = e.target.dataset.noticeId;
                    showConfirmation('‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®', '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶®‡ßã‡¶ü‡¶ø‡¶∂‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?', async () => {
                        await deleteDoc(doc(db, `messes/${currentMessId}/notices`, noticeId));
                        showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶∂‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                    });
                });
            });
            
            document.getElementById('meal-message-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = document.getElementById('meal-message-text').value;
                if (!message) return;
                
                await addDoc(collection(db, `messes/${currentMessId}/mealRequests`), {
                    userId: userData.id,
                    userName: userData.name,
                    message,
                    timestamp: Timestamp.now(),
                    isHandled: false
                });

                document.getElementById('meal-message-text').value = '';
                showToast('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
            });
        }
        
        function attachDashboardNoticeEditListener() {
            document.querySelectorAll('.edit-notice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const noticeId = e.target.dataset.noticeId;
                    const currentTitle = e.target.dataset.noticeTitle;
                    const currentContent = e.target.dataset.noticeContent;
                    
                    const content = `
                        <form id="edit-notice-form">
                            <input type="text" id="edit-notice-title" value="${currentTitle}" class="w-full p-2 border rounded mb-2" required>
                            <textarea id="edit-notice-content" class="w-full p-2 border rounded mb-4" rows="4" required>${currentContent}</textarea>
                        </form>`;
                    const footer = `<button id="update-notice-submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                    showModal('‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ', content, footer);

                    document.getElementById('update-notice-submit').addEventListener('click', async () => {
                        const newTitle = document.getElementById('edit-notice-title').value;
                        const newContent = document.getElementById('edit-notice-content').value;
                        if (!newTitle || !newContent) { showToast('‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§', 'error'); return; }
                        await updateDoc(doc(db, `messes/${currentMessId}/notices`, noticeId), { title: newTitle, content: newContent });
                        closeModal();
                        showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                    });
                });
            });
        }
        // ... (rest of the file remains the same)
        // ==================== MY PROFILE ====================
        // ... (existing code for myProfile)
        async function renderMyProfile() {
            const myRent = userData.rent || 0;
            const myTotalMeal = await calculateTotalMealForUser(userData.id);
            const myTotalBazar = await calculateTotalBazarForUser(userData.id);
            const totalMealRate = myTotalMeal > 0 ? (await calculateTotalMonthlyBazar() - (messData.shopCredit || 0)) / (await calculateTotalAllMemberMeals() || 1) : 0;
            const myTotalCost = myRent + (myTotalMeal * totalMealRate) + (myTotalBazar);
            const myMonthlyBill = myRent + (myTotalMeal * totalMealRate) - myTotalBazar;

            pageContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</h2>
                    <table class="w-full text-sm text-left">
                        <tbody>
                            <tr><td class="p-2 font-medium">‡¶®‡¶æ‡¶Æ</td><td class="p-2">${userData.name}</td></tr>
                            <tr><td class="p-2 font-medium">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</td><td class="p-2">${userData.phone}</td></tr>
                            <tr><td class="p-2 font-medium">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</td><td class="p-2">${userData.email}</td></tr>
                            <tr><td class="p-2 font-medium">‡¶≠‡ßÇ‡¶Æ‡¶ø‡¶ï‡¶æ</td><td class="p-2">${userData.role === 'admin' ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø'}</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <h2 class="text-xl font-bold mb-4">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ (${new Date(currentMonth).toLocaleString('bn-BD', { month: 'long', year: 'numeric' })})</h2>
                    <p class="mb-2"><strong>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶≠‡¶æ‡ßú‡¶æ:</strong> ${toBengaliNum(myRent)} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                    <p class="mb-2"><strong>‡¶Æ‡ßã‡¶ü ‡¶Æ‡¶ø‡¶≤:</strong> ${toBengaliNum(myTotalMeal)} ‡¶ü‡¶ø</p>
                    <p class="mb-2"><strong>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞:</strong> ${toBengaliNum(myTotalBazar)} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                    <p class="mb-2"><strong>‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö:</strong> ${toBengaliNum(myTotalCost.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                    <h3 class="text-lg font-bold mt-4">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶ø‡¶≤: ${toBengaliNum(myMonthlyBill.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ</h3>
                </div>
            `;
        }
        
        // ==================== BAZAR KHOROCH ====================
        // ... (existing code for bazarKhoroch)
        async function renderBazarKhoroch() {
            // Unsubscribe from previous listener to avoid memory leak
            if (window.bazarListener) window.bazarListener();

            const startOfMonth = currentMonth + '-01';
            const endOfMonth = new Date(new Date(currentMonth).getFullYear(), new Date(currentMonth).getMonth() + 1, 0).toISOString().slice(0, 10);
            
            const q = query(collection(db, `messes/${currentMessId}/bazars`), where("date", ">=", startOfMonth), where("date", "<=", endOfMonth));

            window.bazarListener = onSnapshot(q, (querySnapshot) => {
                const bazarList = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b) => new Date(b.date) - new Date(a.date));
                const totalBazar = bazarList.reduce((sum, item) => sum + parseFloat(item.amount), 0);

                let html = `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                            <span>‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö (${new Date(currentMonth).toLocaleString('bn-BD', { month: 'long', year: 'numeric' })})</span>
                            <input type="month" id="bazar-month-selector" value="${currentMonth}" class="p-1 border rounded">
                        </h2>
                        ${userData.role === 'admin' ? `
                            <button id="add-bazar-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg mb-4 hover:bg-green-600">‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        ` : ''}
                        
                        <p class="mb-4 text-lg font-semibold">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: ${toBengaliNum(totalBazar.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ</p>

                        <div id="bazar-list" class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 border">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                        <th class="p-2 border">‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                        <th class="p-2 border">‡¶ü‡¶æ‡¶ï‡¶æ</th>
                                        <th class="p-2 border">‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø</th>
                                        ${userData.role === 'admin' ? `<th class="p-2 border text-center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>` : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${bazarList.length > 0 ? bazarList.map(item => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-2 border">${formatDate(new Date(item.date))}</td>
                                            <td class="p-2 border">${item.description}</td>
                                            <td class="p-2 border">${toBengaliNum(parseFloat(item.amount).toFixed(2))}</td>
                                            <td class="p-2 border">${membersData.find(m => m.id === item.userId)?.name || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ'}</td>
                                            ${userData.role === 'admin' ? `
                                                <td class="p-2 border text-center">
                                                    <button class="delete-bazar-btn text-red-500 hover:underline" data-id="${item.id}">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
                                                </td>
                                            ` : ''}
                                        </tr>
                                    `).join('') : `
                                        <tr><td colspan="${userData.role === 'admin' ? '5' : '4'}" class="p-4 text-center text-gray-500">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</td></tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                pageContent.innerHTML = html;
                attachBazarKhorochListeners();
            });
        }
        
        function attachBazarKhorochListeners() {
            document.getElementById('bazar-month-selector').addEventListener('change', (e) => {
                currentMonth = e.target.value;
                navigateTo('bazarKhoroch', true);
            });

            if(userData.role === 'admin') {
                document.getElementById('add-bazar-btn')?.addEventListener('click', () => {
                    const memberOptions = membersData.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                    const content = `
                        <form id="add-bazar-form">
                            <div class="mb-2"><input type="date" id="bazar-date" class="w-full p-2 border rounded" value="${toYYYYMMDD(new Date())}" required></div>
                            <div class="mb-2"><input type="text" id="bazar-description" placeholder="‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" class="w-full p-2 border rounded" required></div>
                            <div class="mb-2"><input type="number" id="bazar-amount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" class="w-full p-2 border rounded" step="0.01" required></div>
                            <div class="mb-4">
                                <select id="bazar-user" class="w-full p-2 border rounded" required>
                                    <option value="" disabled selected>‡¶ï‡ßã‡¶® ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®?</option>
                                    ${memberOptions}
                                </select>
                            </div>
                        </form>
                    `;
                    const footer = `<button id="add-bazar-submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                    showModal('‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®', content, footer);
                    document.getElementById('add-bazar-submit').addEventListener('click', async () => {
                        const date = document.getElementById('bazar-date').value;
                        const description = document.getElementById('bazar-description').value;
                        const amount = document.getElementById('bazar-amount').value;
                        const userId = document.getElementById('bazar-user').value;
                        if (!date || !description || !amount || !userId) { showToast('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error'); return; }
                        await addDoc(collection(db, `messes/${currentMessId}/bazars`), { date, description, amount: parseFloat(amount), userId, createdAt: Timestamp.now() });
                        closeModal();
                        showToast('‡¶ñ‡¶∞‡¶ö ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                    });
                });
                
                document.querySelectorAll('.delete-bazar-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const bazarId = e.target.dataset.id;
                        showConfirmation('‡¶ñ‡¶∞‡¶ö ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®', '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶ñ‡¶∞‡¶ö‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?', async () => {
                            await deleteDoc(doc(db, `messes/${currentMessId}/bazars`, bazarId));
                            showToast('‡¶ñ‡¶∞‡¶ö‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                        });
                    });
                });
            }
        }

        // ==================== MEAL COUNT ====================
        // ... (existing code for mealCount)
        async function renderMealCount() {
            // Unsubscribe from previous listener to avoid memory leak
            if (window.mealCountListener) window.mealCountListener();

            const startOfMonth = currentMonth + '-01';
            const endOfMonth = new Date(new Date(currentMonth).getFullYear(), new Date(currentMonth).getMonth() + 1, 0).toISOString().slice(0, 10);

            const q = query(collection(db, `messes/${currentMessId}/meals`), where("__name__", ">=", startOfMonth), where("__name__", "<=", endOfMonth));

            window.mealCountListener = onSnapshot(q, (querySnapshot) => {
                const mealData = querySnapshot.docs.map(doc => ({ date: doc.id, meals: doc.data().meals || {} }));
                const dailyBazarData = querySnapshot.docs.map(doc => ({ date: doc.id, person: doc.data().dailyBazarPersonName }));
                
                const mealCounts = membersData.reduce((acc, m) => {
                    acc[m.id] = { totalMeals: 0, breakfast: 0, lunch: 0, dinner: 0 };
                    return acc;
                }, {});

                mealData.forEach(day => {
                    for (const userId in day.meals) {
                        if (mealCounts[userId]) {
                            const userMeals = day.meals[userId];
                            mealCounts[userId].breakfast += userMeals.breakfast || 0;
                            mealCounts[userId].lunch += userMeals.lunch || 0;
                            mealCounts[userId].dinner += userMeals.dinner || 0;
                            mealCounts[userId].totalMeals += (userMeals.breakfast || 0) + (userMeals.lunch || 0) + (userMeals.dinner || 0);
                        }
                    }
                });

                let html = `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                            <span>‡¶Æ‡¶ø‡¶≤ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ (${new Date(currentMonth).toLocaleString('bn-BD', { month: 'long', year: 'numeric' })})</span>
                            <input type="month" id="meal-month-selector" value="${currentMonth}" class="p-1 border rounded">
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 border">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</th>
                                        <th class="p-2 border text-center">‡¶∏‡¶ï‡¶æ‡¶≤</th>
                                        <th class="p-2 border text-center">‡¶¶‡ßÅ‡¶™‡ßÅ‡¶∞</th>
                                        <th class="p-2 border text-center">‡¶∞‡¶æ‡¶§</th>
                                        <th class="p-2 border text-center">‡¶Æ‡ßã‡¶ü ‡¶Æ‡¶ø‡¶≤</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${membersData.map(m => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-2 border">${m.name}</td>
                                            <td class="p-2 border text-center">${toBengaliNum(mealCounts[m.id]?.breakfast || 0)}</td>
                                            <td class="p-2 border text-center">${toBengaliNum(mealCounts[m.id]?.lunch || 0)}</td>
                                            <td class="p-2 border text-center">${toBengaliNum(mealCounts[m.id]?.dinner || 0)}</td>
                                            <td class="p-2 border text-center font-bold">${toBengaliNum(mealCounts[m.id]?.totalMeals.toFixed(1) || 0)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                pageContent.innerHTML = html;
                attachMealCountListeners();
            });
        }
        
        function attachMealCountListeners() {
            document.getElementById('meal-month-selector').addEventListener('change', (e) => {
                currentMonth = e.target.value;
                navigateTo('mealCount', true);
            });
        }

        // ==================== MONTHLY REPORT ====================
        // ... (existing code for monthlyReport)
        async function renderMonthlyReport() {
            const totalMonthlyBazar = await calculateTotalMonthlyBazar();
            const totalAllMemberMeals = await calculateTotalAllMemberMeals();
            const mealRate = totalAllMemberMeals > 0 ? (totalMonthlyBazar - (messData.shopCredit || 0)) / totalAllMemberMeals : 0;
            
            const memberReports = await Promise.all(membersData.map(async (member) => {
                const totalMeals = await calculateTotalMealForUser(member.id);
                const totalBazar = await calculateTotalBazarForUser(member.id);
                const totalCost = (member.rent || 0) + (totalMeals * mealRate) + totalBazar;
                const monthlyBill = (member.rent || 0) + (totalMeals * mealRate) - totalBazar;
                return {
                    ...member,
                    totalMeals: totalMeals,
                    totalBazar: totalBazar,
                    totalCost: totalCost,
                    monthlyBill: monthlyBill
                };
            }));
            
            let html = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                        <span>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ (${new Date(currentMonth).toLocaleString('bn-BD', { month: 'long', year: 'numeric' })})</span>
                        <input type="month" id="report-month-selector" value="${currentMonth}" class="p-1 border rounded">
                    </h2>
                    <div class="mb-4 space-y-2">
                        <p><strong>‡¶Æ‡ßá‡¶∏‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö:</strong> ${toBengaliNum(totalMonthlyBazar.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                        <p><strong>‡¶Æ‡ßá‡¶∏‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶Æ‡¶ø‡¶≤ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ:</strong> ${toBengaliNum(totalAllMemberMeals.toFixed(1))} ‡¶ü‡¶ø</p>
                        <p><strong>‡¶Æ‡ßá‡¶∏‡ßá‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø:</strong> ${toBengaliNum(messData.shopCredit.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                        <h3 class="text-lg font-semibold mt-4">‡¶Æ‡¶ø‡¶≤ ‡¶∞‡ßá‡¶ü: ${toBengaliNum(mealRate.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ</h3>
                    </div>
                    ${userData.role === 'admin' ? `
                    <div class="my-4">
                        <button id="update-shop-credit-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 mr-2">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        <button id="generate-pdf-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                    </div>
                    ` : ''}
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left border-collapse" id="report-table">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 border">‡¶®‡¶æ‡¶Æ</th>
                                    <th class="p-2 border text-center">‡¶Æ‡¶ø‡¶≤</th>
                                    <th class="p-2 border text-center">‡¶≠‡¶æ‡ßú‡¶æ</th>
                                    <th class="p-2 border text-center">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</th>
                                    <th class="p-2 border text-center">‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞</th>
                                    <th class="p-2 border text-center font-bold">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</th>
                                    ${userData.role === 'admin' ? `<th class="p-2 border text-center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>` : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${memberReports.map(m => `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="p-2 border">${m.name}</td>
                                        <td class="p-2 border text-center">${toBengaliNum(m.totalMeals.toFixed(1))}</td>
                                        <td class="p-2 border text-center">${toBengaliNum(m.rent.toFixed(2))}</td>
                                        <td class="p-2 border text-center">${toBengaliNum(m.totalCost.toFixed(2))}</td>
                                        <td class="p-2 border text-center">${toBengaliNum(m.totalBazar.toFixed(2))}</td>
                                        <td class="p-2 border text-center font-bold">${toBengaliNum(m.monthlyBill.toFixed(2))}</td>
                                        ${userData.role === 'admin' ? `
                                            <td class="p-2 border text-center">
                                                <a href="https://wa.me/88${m.phone}?text=${encodeURIComponent(`${m.name} ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶ø‡¶≤: ${toBengaliNum(m.monthlyBill.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ‡•§ ${new Date(currentMonth).toLocaleString('bn-BD', { month: 'long', year: 'numeric' })} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡•§`)}" target="_blank" class="text-green-500 hover:underline">WhatsApp</a>
                                            </td>
                                        ` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            pageContent.innerHTML = html;
            attachMonthlyReportListeners(totalMonthlyBazar, totalAllMemberMeals, mealRate, memberReports);
        }

        async function calculateTotalMonthlyBazar() {
            const startOfMonth = currentMonth + '-01';
            const endOfMonth = new Date(new Date(currentMonth).getFullYear(), new Date(currentMonth).getMonth() + 1, 0).toISOString().slice(0, 10);
            const q = query(collection(db, `messes/${currentMessId}/bazars`), where("date", ">=", startOfMonth), where("date", "<=", endOfMonth));
            const querySnapshot = await getDocs(q);
            return querySnapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0);
        }
        
        async function calculateTotalMealForUser(userId) {
            const startOfMonth = currentMonth + '-01';
            const endOfMonth = new Date(new Date(currentMonth).getFullYear(), new Date(currentMonth).getMonth() + 1, 0).toISOString().slice(0, 10);
            const q = query(collection(db, `messes/${currentMessId}/meals`), where("__name__", ">=", startOfMonth), where("__name__", "<=", endOfMonth));
            const querySnapshot = await getDocs(q);
            let totalMeals = 0;
            querySnapshot.docs.forEach(doc => {
                const meals = doc.data().meals[userId];
                if(meals) {
                    totalMeals += (meals.breakfast || 0) + (meals.lunch || 0) + (meals.dinner || 0);
                }
            });
            return totalMeals;
        }

        async function calculateTotalAllMemberMeals() {
            const startOfMonth = currentMonth + '-01';
            const endOfMonth = new Date(new Date(currentMonth).getFullYear(), new Date(currentMonth).getMonth() + 1, 0).toISOString().slice(0, 10);
            const q = query(collection(db, `messes/${currentMessId}/meals`), where("__name__", ">=", startOfMonth), where("__name__", "<=", endOfMonth));
            const querySnapshot = await getDocs(q);
            let totalMeals = 0;
            querySnapshot.docs.forEach(doc => {
                const meals = doc.data().meals;
                for(const userId in meals) {
                    totalMeals += (meals[userId].breakfast || 0) + (meals[userId].lunch || 0) + (meals[userId].dinner || 0);
                }
            });
            return totalMeals;
        }

        async function calculateTotalBazarForUser(userId) {
            const startOfMonth = currentMonth + '-01';
            const endOfMonth = new Date(new Date(currentMonth).getFullYear(), new Date(currentMonth).getMonth() + 1, 0).toISOString().slice(0, 10);
            const q = query(collection(db, `messes/${currentMessId}/bazars`), where("date", ">=", startOfMonth), where("date", "<=", endOfMonth), where("userId", "==", userId));
            const querySnapshot = await getDocs(q);
            return querySnapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0);
        }

        function attachMonthlyReportListeners(totalMonthlyBazar, totalAllMemberMeals, mealRate, memberReports) {
            document.getElementById('report-month-selector').addEventListener('change', (e) => {
                currentMonth = e.target.value;
                navigateTo('monthlyReport', true);
            });
            
            if(userData.role === 'admin') {
                document.getElementById('update-shop-credit-btn')?.addEventListener('click', () => {
                    const content = `<input type="number" id="shop-credit-input" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ" class="w-full p-2 border rounded" value="${messData.shopCredit}" step="0.01">`;
                    const footer = `<button id="update-shop-credit-submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                    showModal('‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®', content, footer);
                    document.getElementById('update-shop-credit-submit').addEventListener('click', async () => {
                        const newCredit = parseFloat(document.getElementById('shop-credit-input').value);
                        if(isNaN(newCredit)) { showToast('‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§', 'error'); return; }
                        await updateDoc(doc(db, 'messes', currentMessId), { shopCredit: newCredit });
                        closeModal();
                        showToast('‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                    });
                });
                
                document.getElementById('generate-pdf-btn')?.addEventListener('click', () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.addFont('Tiro-Bangla-Regular.ttf', 'TiroBangla', 'normal');
                    doc.setFont('TiroBangla');
                    doc.text('‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Æ‡ßá‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü', 14, 20);
                    doc.text(`‡¶Æ‡ßá‡¶∏: ${messData.messName}`, 14, 28);
                    doc.text(`‡¶Æ‡¶æ‡¶∏: ${new Date(currentMonth).toLocaleString('bn-BD', { month: 'long', year: 'numeric' })}`, 14, 36);

                    const head = [['‡¶®‡¶æ‡¶Æ', '‡¶Æ‡¶ø‡¶≤', '‡¶≠‡¶æ‡ßú‡¶æ', '‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö', '‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞', '‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤']];
                    const body = memberReports.map(m => [
                        m.name,
                        toBengaliNum(m.totalMeals.toFixed(1)),
                        toBengaliNum(m.rent.toFixed(2)),
                        toBengaliNum(m.totalCost.toFixed(2)),
                        toBengaliNum(m.totalBazar.toFixed(2)),
                        toBengaliNum(m.monthlyBill.toFixed(2))
                    ]);
                    
                    doc.autoTable({
                        startY: 44,
                        head: head,
                        body: body,
                        theme: 'grid',
                        headStyles: { font: 'TiroBangla', fontStyle: 'normal' },
                        bodyStyles: { font: 'TiroBangla', fontStyle: 'normal' },
                    });

                    doc.text(`‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞: ${toBengaliNum(totalMonthlyBazar.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ`, 14, doc.autoTable.previous.finalY + 10);
                    doc.text(`‡¶Æ‡ßã‡¶ü ‡¶Æ‡¶ø‡¶≤: ${toBengaliNum(totalAllMemberMeals.toFixed(1))} ‡¶ü‡¶ø`, 14, doc.autoTable.previous.finalY + 18);
                    doc.text(`‡¶Æ‡¶ø‡¶≤ ‡¶∞‡ßá‡¶ü: ${toBengaliNum(mealRate.toFixed(2))} ‡¶ü‡¶æ‡¶ï‡¶æ`, 14, doc.autoTable.previous.finalY + 26);
                    
                    doc.save(`monthly_report_${currentMonth}.pdf`);
                });
            }
        }
        
        // ==================== MEMBERS INFO ====================
        // ... (existing code for membersInfo)
        async function renderMembersInfo() {
            pageContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left border-collapse">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 border">‡¶®‡¶æ‡¶Æ</th>
                                    <th class="p-2 border">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                                    <th class="p-2 border">‡¶≠‡¶æ‡ßú‡¶æ</th>
                                    ${userData.role === 'admin' ? `<th class="p-2 border text-center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>` : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${membersData.map(m => `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="p-2 border">${m.name}</td>
                                        <td class="p-2 border">${m.phone}</td>
                                        <td class="p-2 border">${toBengaliNum(m.rent || 0)} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
                                        ${userData.role === 'admin' ? `
                                            <td class="p-2 border text-center">
                                                <button class="edit-rent-btn text-blue-500 hover:underline" data-id="${m.id}" data-name="${m.name}" data-rent="${m.rent || 0}">‡¶≠‡¶æ‡ßú‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
                                            </td>
                                        ` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            attachMembersInfoListeners();
        }
        
        function attachMembersInfoListeners() {
            if(userData.role === 'admin') {
                document.querySelectorAll('.edit-rent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.id;
                        const userName = e.target.dataset.name;
                        const currentRent = e.target.dataset.rent;
                        const content = `<input type="number" id="new-rent-input" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶æ‡ßú‡¶æ" class="w-full p-2 border rounded" value="${currentRent}" step="0.01">`;
                        const footer = `<button id="update-rent-submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                        showModal(`${userName} ‡¶è‡¶∞ ‡¶≠‡¶æ‡ßú‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®`, content, footer);
                        document.getElementById('update-rent-submit').addEventListener('click', async () => {
                            const newRent = parseFloat(document.getElementById('new-rent-input').value);
                            if(isNaN(newRent)) { showToast('‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§', 'error'); return; }
                            await updateDoc(doc(db, 'users', userId), { rent: newRent });
                            closeModal();
                            showToast('‡¶≠‡¶æ‡ßú‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                        });
                    });
                });
            }
        }
        // ==================== DEVELOPER INFO ====================
        // ... (existing code for developerInfo)
        function renderDeveloperInfo() {
            pageContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow text-center">
                    <h2 class="text-xl font-bold mb-4">‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h2>
                    <p class="text-lg">‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®: ‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¶ ‡¶π‡ßã‡¶∏‡ßá‡¶®</p>
                    <p>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó: <a href="tel:+8801904711679" class="text-blue-500 hover:underline">01904711679</a></p>
                </div>
            `;
        }
        
        // ==================== APPROVALS ====================
        // ... (existing code for approvals)
        async function renderApprovals() {
            // Unsubscribe from previous listener to avoid memory leak
            if (window.approvalListener) window.approvalListener();
            
            const q = query(collection(db, "users"), where("messId", "==", `pending_${currentMessId}`));
            
            window.approvalListener = onSnapshot(q, (querySnapshot) => {
                const pendingMembers = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                let html = `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</h2>
                        <div class="space-y-4">
                            ${pendingMembers.length > 0 ? pendingMembers.map(member => `
                                <div class="flex justify-between items-center border-b pb-2">
                                    <div>
                                        <p class="font-semibold">${member.name}</p>
                                        <p class="text-sm text-gray-500">${member.email}</p>
                                    </div>
                                    <div>
                                        <button class="approve-btn bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600" data-id="${member.id}">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</button>
                                        <button class="deny-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 ml-2" data-id="${member.id}">‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®</button>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á‡•§</p>'}
                        </div>
                    </div>
                `;
                pageContent.innerHTML = html;
                attachApprovalListeners();
            });
        }
        
        function attachApprovalListeners() {
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userId = e.target.dataset.id;
                    await updateDoc(doc(db, "users", userId), { messId: currentMessId });
                    showToast('‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶ï‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                });
            });
            
            document.querySelectorAll('.deny-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userId = e.target.dataset.id;
                    await updateDoc(doc(db, "users", userId), { messId: null });
                    showToast('‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'info');
                });
            });
        }
        
        // ==================== MEAL REQUESTS ====================
        // ... (existing code for mealRequests)
        async function renderMealRequests() {
            // Unsubscribe from previous listener to avoid memory leak
            if (window.mealRequestListener) window.mealRequestListener();
            
            const q = query(collection(db, `messes/${currentMessId}/mealRequests`), where("isHandled", "==", false));
            
            window.mealRequestListener = onSnapshot(q, (querySnapshot) => {
                const requests = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b) => a.timestamp - b.timestamp);
                
                let html = `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">‡¶Æ‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</h2>
                        <div class="space-y-4">
                            ${requests.length > 0 ? requests.map(req => `
                                <div class="border p-4 rounded-lg">
                                    <p class="font-semibold">${req.userName} - <span class="text-sm font-normal text-gray-500">${formatDateTime(req.timestamp.toDate())}</span></p>
                                    <p class="mt-2 whitespace-pre-wrap">${req.message}</p>
                                    <div class="mt-4 text-right">
                                        <button class="mark-as-handled-btn bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600" data-id="${req.id}">‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá</button>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶®‡ßá‡¶á‡•§</p>'}
                        </div>
                    </div>
                `;
                pageContent.innerHTML = html;
                attachMealRequestListeners();
            });
        }
        
        function attachMealRequestListeners() {
            document.querySelectorAll('.mark-as-handled-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const requestId = e.target.dataset.id;
                    await updateDoc(doc(db, `messes/${currentMessId}/mealRequests`, requestId), { isHandled: true });
                    showToast('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                });
            });
        }
        
    </script>
</body>
</html>